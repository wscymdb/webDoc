#  1.ä»‹ç»

## 1.1 nginxä¼˜åŠ¿



* **é«˜å¹¶å‘é«˜æ€§èƒ½**
* **å¯æ‹“å±•æ€§å¥½**
  * nginxæºç å†…æ ¸éå¸¸å°ï¼ŒåŠŸèƒ½ä¸å¤šï¼Œä½†æ˜¯ä»–çš„æ¯ä¸ªåŠŸèƒ½éƒ½æ˜¯é€šè¿‡æ¨¡å—å®ç°çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ·»åŠ å’Œåˆ é™¤æ¨¡å—æ¥å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¸”éå¸¸æ–¹ä¾¿äºŒæ¬¡å¼€å‘
* **é«˜å¯é æ€§**
* **çƒ­éƒ¨ç½²**
  * ç±»ä¼¼äºå‰ç«¯çš„çƒ­æ›´æ–°ï¼Œè€Œä¸”æ˜¯ä¸æ»‘éƒ¨ç½²ï¼Œå½“æ›´æ–°é…ç½®çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª.oldåç¼€çš„æ–‡ä»¶ï¼Œæ¯”å¦‚aå®¢æˆ·ç«¯æ­£åœ¨è®¿é—®ï¼Œè¿™æ—¶å€™æ›´æ–°äº†é…ç½®ï¼Œè¿™æ—¶å€™ä¼šå°†è€çš„é…ç½®ç”Ÿæˆ.oldåç¼€çš„æ–‡ä»¶ é‚£ä¹ˆaå®¢æˆ·ç«¯ä¼šç»§ç»­è®¿é—®.oldåç¼€é…ç½®ç›¸å…³çš„å†…å®¹ï¼Œç°åœ¨bå®¢æˆ·ç«¯æ¥è®¿é—®ï¼Œå°±ä¼šè®¿é—®æ–°çš„é…ç½®æ–‡ä»¶
* **å¼€æºè®¸å¯è¯**



## 1.2 nginxçš„æ¶æ„

### 1.2.1 è½»é‡

* æºç åªåŒ…å«æ ¸å¿ƒæ¨¡å—
* å…¶ä»–éæ ¸å¿ƒåŠŸèƒ½éƒ½æ˜¯é€šè¿‡æ¨¡å—å®ç°çš„ï¼Œå¯è‡ªç”±é€‰æ‹©

### 1.2.2 æ¶æ„

nginxé‡‡ç”¨çš„æ˜¯å¤šè¿›ç¨‹(å•çº¿ç¨‹)å’Œå¤šè·¯IOå¤ç”¨æ¨¡å‹



### 1.2.3 å·¥ä½œæµç¨‹

* Nginxåœ¨å¯åŠ¨åï¼Œä¼šæœ‰ä¸€ä¸ªmasterè¿›ç¨‹å’Œå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„workerè¿›ç¨‹
* masterè¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæŠŠè¿™ä¸ªè¯·æ±‚åˆ†é…ç»™workerè¿›ç¨‹ï¼Œæ‰€ä»¥æ¯ä¸ªworkerè¿›ç¨‹éƒ½å¯èƒ½ä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚(æœ‰å¯èƒ½ç¬¬ä¸€ä¸ªworkerå¤„ç†ï¼Œä¹Ÿå¯èƒ½ç¬¬äºŒä¸ªworkerå¤„ç†)
* masterè¿›ç¨‹èƒ½ç›‘æ§workerè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œå½“workerè¿›ç¨‹é€€å‡ºå(å¼‚å¸¸æƒ…å†µä¸‹)ï¼Œä¼šå¯åŠ¨æ–°çš„workerè¿›ç¨‹

[å·¥ä½œæµç¨‹å›¾](https://excalidraw.com/#json=tvponPHAvQTD7eXarIzyw,PSCPS4j4Fb8198InfMruOA)



* workerè¿›ç¨‹æ•°ï¼Œä¸€èˆ¬ä¼šè®¾ç½®æˆæœºå™¨çš„cpuæ ¸æ•°ï¼Œå› ä¸ºæ›´å¤šçš„workeræ•°ï¼Œåªä¼šå¯¼è‡´è¿›ç¨‹ç›¸äº’ç«äº‰cpuï¼Œä»è€Œå¸¦æ¥ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢
* ä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å¼ï¼Œä¸ä»…èƒ½æé«˜å¹¶å‘ç‡ï¼Œè€Œä¸”è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸€ä¸ªworkerè¿›ç¨‹æŒ‚äº†ä¸ä¼šå½±å“åˆ°å…¶ä»–workerè¿›ç¨‹



**ä¸¾ä¾‹**

æ¯”å¦‚ç°åœ¨é…’åº—æœ‰é¢†ç­çš„ï¼Œé¢†ç­çš„ä¼šåˆ†é…ä¸åŒæœåŠ¡å‘˜æ¥å¾…çš„åŒºåŸŸï¼Œé¢†ç­ä¸€èˆ¬æ˜¯ä¸ä¼šå»æ¥å¾…çš„ï¼Œä»–åªè´Ÿè´£ç»Ÿç­¹æœåŠ¡å‘˜ï¼Œæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªæœåŠ¡å‘˜è¦è¯·å‡äº†ï¼Œé‚£ä¹ˆä»–å°±ä¼šèµ¶ç´§å®‰æ’æ–°çš„æœåŠ¡å‘˜å»è´Ÿè´£è¿™ç‰‡åŒºåŸŸã€‚

é‚£ä¹ˆmasterå°±ç›¸å½“äºé¢†ç­ï¼Œå½“æœ‰workerè¿›ç¨‹æŒ‚äº†ï¼Œä¼šå¯åŠ¨æ–°çš„workerè¿›ç¨‹



# 2.å®‰è£…

## Linuxä¸‹å®‰è£…

**CentOS 7**

```bash
yum install nginx -y  # å®‰è£…

nginx -v  # æŸ¥çœ‹ç‰ˆæœ¬å·

nginx -V # æŸ¥çœ‹ç¼–è¯‘æ—¶çš„å‚æ•°
```



**nginx -V å‚æ•°è¡¨ç¤ºçš„æ„æ€**

```
--prefix  # æŠŠnginxå®‰è£…åˆ°å“ªä¸ªç›®å½•ä¸‹
--sbin-path # å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„
--modules-path # å®‰è£…çš„é¢å¤–æ¨¡å—è·¯å¾„
--conf-path # é…ç½®æ–‡ä»¶çš„è·¯å¾„
--error-log-path # é”™è¯¯æ—¥å¿—è·¯å¾„
--http-log-path= # æ™®é€šæ—¥å¿—è·¯å¾„
--pid-path # è¿›ç¨‹IDè·¯å¾„
--lock-path # åŠ é”æ–‡ä»¶è·¯å¾„

-------ä¸‹é¢æ˜¯demo-----------
--prefix=/usr/share/nginx
--sbin-path=/usr/sbin/nginx 
--modules-path=/usr/lib64/nginx/modules
--conf-path=/etc/nginx/nginx.conf
--error-log-path=/var/log/nginx/error.log
--http-log-path=/var/log/nginx/access.log 
--http-client-body-temp-path=/var/lib/nginx/tmp/client_body
--http-proxy-temp-path=/var/lib/nginx/tmp/proxy
--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi 
--http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi
--http-scgi-temp-path=/var/lib/nginx/tmp/scgi 
--pid-path=/run/nginx.pid
--lock-path=/run/lock/subsys/nginx 
--user=nginx
--group=nginx
--with-compat
--with-debug
--with-file-aio 
--with-google_perftools_module
--with-http_addition_module
--with-http_auth_request_module
--with-http_dav_module
--with-http_degradation_module
--with-http_flv_module 
--with-http_gunzip_module 
--with-http_gzip_static_module 
--with-http_image_filter_module=dynamic
--with-http_mp4_module
--with-http_perl_module=dynamic
--with-http_random_index_module 
--with-http_realip_module 
--with-http_secure_link_module
--with-http_slice_module 
--with-http_ssl_module 
--with-http_stub_status_module
--with-http_sub_module 
--with-http_v2_module
--with-http_xslt_module=dynamic
--with-mail=dynamic
--with-mail_ssl_module
--with-pcre
--with-pcre-jit 
--with-stream=dynamic
--with-stream_ssl_module
--with-stream_ssl_preread_module
--with-threads
--with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong
--param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'
```

# 3.ç›®å½•

## 3.1 å®‰è£…ç›®å½•

**æŸ¥çœ‹nginxå®‰è£…çš„é…ç½®ç›®å½•å’Œæ–‡ä»¶**

* æŸ¥çœ‹å®‰è£…nginxçš„æ—¶å€™ä¼šå®‰è£…å“ªäº›æ–‡ä»¶ï¼Œå’Œå½“å‰æ–‡ä»¶çš„è·¯å¾„
* ä¸‹é¢çš„xxxæ–‡ä»¶éƒ½æ˜¯è¿™ä¸ªå‘½ä»¤æ˜¾ç¤ºçš„æ–‡ä»¶

```bash
rpm -ql nginx
```

## 3.2 é…ç½®æ–‡ä»¶æ ¸å¿ƒç»“æ„

```nginx
```



## 3.3 ä¸»é…ç½®æ–‡ä»¶

### 3.3.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶

ç›®å½•åœ°å€ï¼š**/etc/nginx/nginx.conf**



```nginx
# nginxçš„key å’Œvalue æ˜¯é ç©ºæ ¼åˆ†éš” ç©ºæ ¼çš„æ•°é‡æ˜¯ä»»æ„çš„

user             nginx;  # å¯ç”¨nginxçš„ç”¨æˆ·
worker_processes auto; # workerè¿›ç¨‹æ•°é‡ ä¸€èˆ¬è¦å’Œcpuæ ¸æ•°ç›¸ç­‰

error_log /var/log/nginx/error.log warn; # é”™è¯¯æ—¥å¿—çš„è·¯å¾„ warn è¡¨ç¤ºæ—¥å¿—çš„æ ¼å¼ æœ‰çš„é…ç½®æ–‡ä»¶å¯èƒ½æ²¡æœ‰
pid       /run/nginx.pid; # è¿›ç¨‹IDå†™å…¥çš„æ–‡ä»¶


events {
    worker_connections 1024; # å·¥ä½œè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•° å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°çš„è¿æ¥å°±ä¼šè¢«ä¸¢æ‰
}

http {
  	# å®šä¹‰æ—¥å¿—çš„æ ¼å¼
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main; # è®¿é—®æ—¥å¿—å†™å…¥çš„æ–‡ä»¶ mianè¡¨ç¤ºä½¿ç”¨è¿™ä¸­æ ¼å¼å†™å…¥

    sendfile            on; # é›¶æ‹·è´æ¨¡å¼å¼€å…³
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65; # ä¿æŒè¿æ¥çš„è¶…æ—¶æ—¶é—´
    types_hash_max_size 4096;
  	# gzip                on; # æ˜¯å¦å¯ç”¨gzipå‹ç¼©

    include             /etc/nginx/mime.types; # åŒ…å«çš„mimeæ–‡ä»¶  æ¯”å¦‚å®¢æˆ·ç«¯è®¿é—®index.jsé‚£ä¹ˆæœåŠ¡å™¨å°±ä¼šè¿”å›ä¸€ä¸ªContentâ€”typeå­—æ®µå€¼å°±æ˜¯ æ ¹æ®è®¿é—®çš„æ–‡ä»¶(index.js)ç”Ÿæˆçš„ç±»å‹ è¿™ä¸ªç±»å‹ä¸€å®šæ˜¯mimeæ–‡ä»¶çš„æŸä¸ªç±»å‹ï¼Œå› ä¸ºè¿™æ ·nginxæ‰è®¤è¯†
    default_type        application/octet-stream;  # å¦‚æœç°åœ¨è¿”å›çš„ä¸€ä¸ªç±»å‹ä¸åœ¨mimeæ–‡ä»¶ä¸­ é‚£ä¹ˆå°±ä¼šä½¿ç”¨è¿™ä¸ªé»˜è®¤çš„ç±»å‹è¿”å›ç»™æµè§ˆå™¨

   
    include /etc/nginx/conf.d/*.conf;  # è¿˜è¦åŒ…å«è¿™ä¸ªæ–‡ä»¶ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶

}

```



### 3.3.2 é»˜è®¤httpæœåŠ¡é…ç½®æ–‡ä»¶

ç›®å½•åœ°å€ï¼š**/etc/nginx/nginx.conf.default** 

```nginx
# httpåªæœ‰ä¸€ä¸ªã€‚é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªserver
http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main; # è®¿é—®æ—¥å¿—å†™å…¥çš„æ–‡ä»¶ mianè¡¨ç¤ºä½¿ç”¨è¿™ä¸­æ ¼å¼å†™å…¥

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
  
   # é…ç½®æœåŠ¡çš„ ä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„é…ç½®æ–‡ä»¶
    server {
        listen       80; # ç›‘å¬çš„ç«¯å£ nginxå¯åŠ¨åé»˜è®¤ç›‘å¬80ç«¯å£
        server_name  localhost; # æœåŠ¡åå­—æˆ–è€…æ˜¯åŸŸåæˆ–è€…æ˜¯IP

        #charset koi8-r; # å­—ç¬¦é›† ä¿„è¯­çš„å­—ç¬¦é›† å› ä¸ºä½œè€…æ˜¯ä¿„ç½—æ–¯çš„ æ‰€ä»¥é»˜è®¤å†™äº†ä¸€ä¸ªè¿™ä¸ª å¯ä»¥è‡ªå·±è®¾ç½®

        #access_log  logs/host.access.log  main;
				
    		# locationæ˜¯é‡ç‚¹ä¹‹ä¸­çš„é‡ç‚¹ 
    		# è¡¨ç¤ºå¦‚æœè®¿é—®/ é‚£ä¹ˆå°±ä¼šè¿›å…¥è¿™ä¸ªé…ç½® ç„¶åå»htmlæ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°index.html å¦‚æœindex.htmlæ²¡æœ‰å°±æ‰¾ index.htm
        location / {
            root   html; # æ–‡ä»¶æ ¹è·¯å¾„ 
            index  index.html index.htm; # é»˜è®¤è®¿é—®çš„æ–‡ä»¶
        }

        #error_page  404              /404.html; 

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html; # å¦‚æœçŠ¶æ€ç æ˜¯500 502 503 504 é‡å®šå‘50x.html
        location = /50x.html {
            root   html;
        }
    }    
}
```

# 4.serveræ¨¡å—

**nginxæœ‰ä¸€ä¸ªä¸»é…ç½®æ–‡ä»¶`nginx.conf`é‡Œé¢æœ‰ä¸€ä¸ªï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ª`http`, `http	`ä¸­å¯ä»¥æœ‰å¤šä¸ª`server`**



## 4.1.rootå’Œaliasçš„åŒºåˆ«

* ä½¿ç”¨root é‚£ä¹ˆåœ¨è®¿é—®çš„æ—¶å€™å°±ä¼š**æ‹¼æ¥locationå¯¹åº”çš„åœ°å€**

```nginx
# å½“è®¿é—®/randomçš„æ—¶å€™ nginxä¼šå» /opt/app/randomæ–‡ä»¶å¤¹ä¸‹å¯»æ‰¾æ–‡ä»¶
server {
  location /random {
    root /opt/app;
    index index.html;
  }
}
```





* ä½¿ç”¨alias è®¿é—®çš„æ—¶å€™**ä¸ä¼š**æ‹¼æ¥locationå¯¹åº”çš„åœ°å€

```nginx
# å½“è®¿é—®/randomçš„æ—¶å€™ nginxä¼šå» /opt/appæ–‡ä»¶å¤¹ä¸‹å¯»æ‰¾æ–‡ä»¶
server {
  location /random {
    root /opt/app;
    index index.html;
  }
}
```



# 5.æ ¸å¿ƒæ¨¡å—

**åœ¨ä½¿ç”¨ä¸‹é¢çš„æ¨¡å—æ—¶å€™ ä½¿ç”¨`nginx -V`æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ä¸‹é¢çš„æ¨¡å— é¿å…ä¸ç”Ÿæ•ˆ**

##  5.1 ç›‘æ§nginxå®¢æˆ·ç«¯çš„çŠ¶æ€

**æ¨¡å—å**

```
--with-http_stub_status_module
```

**è¯­æ³•**

```
# Syntax è¡¨ç¤ºè¯­æ³•
# Default è¡¨ç¤ºé»˜è®¤å€¼
# Context è¡¨ç¤ºè¿™ä¸ªæ¨¡å—å¯ä»¥å†™åœ¨å“ªé‡Œ è¿™é‡Œè¡¨ç¤ºå¯ä»¥å†™åœ¨serverçš„locationä¸­

Syntax: stub_status on/of;
Default: -
Context: server->location
```



**ä¸¾ä¾‹**

```nginx
# å¯ä»¥åœ¨nginx.confæ–‡ä»¶çš„serverçš„locationé…ç½®

http {
	server {
		# é…ç½®ä¸€ä¸ªlocation
		location /status {
			stub_status on;
		}
	}
}

# é…äº†ä¸€ä¸ªlocation ç„¶åé‡å¯ä¸€ä¸‹nginx åœ¨é¡µé¢è¾“å…¥xxx.xxx.xxx/status
# åœ¨é¡µé¢å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å†…å®¹

Active connections: 2 # å½“å‰nginxæ­£åœ¨å¤„ç†æ´»åŠ¨çš„è¿æ¥æ•°
# serverè¡¨ç¤ºåç§° æ¯”å¦‚server acceptsè¡¨ç¤º æœåŠ¡å™¨å¤„ç†çš„è¿æ¥æ•°  server handled  server requests
# accepts  æ€»å…±å¤„ç†çš„è¿æ¥æ•°
# handled  æˆåŠŸåˆ›å»ºçš„æ¡æ‰‹æ•°
# requests æ€»å…±å¤„ç†çš„è¯·æ±‚æ•°
server accepts handled requests
 					25 			25 			23 
# Reading è¯»å–åˆ°å®¢æˆ·ç«¯Headerä¿¡æ¯ è¡¨ç¤ºæ­£åœ¨è¯»å–å®¢æˆ·ç«¯Headerçš„æ•°é‡æ˜¯0
# Writing æ­£åœ¨è¿”å›ç»™å®¢æˆ·ç«¯Headerä¿¡æ¯
# Waiting ç­‰å¾…  å¦‚æœå¼€å¯äº†keep-alive é‚£ä¹ˆä»–çš„æ•°é‡æ˜¯ Active connections - (Reading+Writing)
Reading: 0 Writing: 1 Waiting: 1 


# è¿™äº›ä¿¡æ¯çš„ä½œç”¨ï¼Ÿ
# å¯ä»¥æŸ¥çœ‹nginxå½“å‰çš„è´Ÿè½½ 
```

## 5.2.éšæœºæ¨¡å—

**æ¨¡å—å**

```
--with-http_random_index_module
```

**ä½œç”¨**

```
åœ¨ç»™å®šçš„ç›®å½•ä¸‹éšæœºæ˜¾ç¤ºä¸€ä¸ªé¡µé¢æ¥æ˜¾ç¤º
```

**è¯­æ³•**

```
Syntax: random_index  on/off;
Default: off
Contxt: location
```

**ä¾‹å­**

```nginx
# å½“è®¿é—®xxx.xxx.xxx:8888/randomçš„æ—¶å€™ä¼šéšæœºæ˜¾ç¤º/opt/appæ–‡ä»¶å¤¹ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶æ¥æ˜¾ç¤º
server {
    listen 8888;
    server_name localhost;
    location  /random {
         alias /opt/app;
         random_index on;
      }
}
```

## 5.3 å†…å®¹æ›¿æ¢æ¨¡å—

 **æ¨¡å—å**

```
--with-http_sub_module
```

**è¯­æ³•**

```
Syntax: sub_filter string replacement;
Default: --
Context: httpã€serviceã€location
```



**ä¾‹å­**

```nginx
# å½“è®¿é—®/randomæ—¶ ä¼šæŠŠname æ›¿æ¢æˆjack ä¼šæŠŠ<h1>name</h1> æ›¿æ¢æˆ <h1>jack</h1> è¿”å›ç»™æµè§ˆå™¨
# æ¯”å¦‚ç°åœ¨index.htmlä¸­æœ‰ name abc <h1>name</h1>è¿™äº›å†…å®¹ã€‚
# é‚£ä¹ˆåœ¨å“åº”çš„æ—¶å€™ä¼šæŠŠåŒ¹é…åˆ°çš„æ›¿æ¢æ‰ è¿”å›çš„å°±æ˜¯ jack abc <h1>jack</h1>

server {
    listen 8888;
    server_name localhost;
    location  /random {
         alias /opt/app;
         index index.html;
         sub_filter 'name' 'jack';
         sub_filter <h1>name</h1> <h1>jack</h1>;
      }
}
```

## 5.4 è¯·æ±‚é™åˆ¶

**æ¨¡å—å**

```
# è¿æ¥é¢‘ç‡é™åˆ¶
--with-limit_conn_module
# è¯·æ±‚é¢‘ç‡é™åˆ¶
--with-limit_req_module
```

### 5.4.1 abæ¨¡å—

**ä½œç”¨**

```
è¿™æ˜¯Apacheçš„abå‘½ä»¤ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šçº¿ç¨‹å¹¶å‘è¯·æ±‚ï¼Œæµ‹è¯•æœåŠ¡å™¨è´Ÿè½½å‹åŠ›ï¼Œä¹Ÿå¯ä»¥æµ‹è¯•nginxã€lighthttpã€IIsç­‰å…¶ä»–WebæœåŠ¡å™¨çš„å‹åŠ›ï¼Œå› ä¸ºæˆ‘ä»¬è¿™ä¸ªæ¨¡å—æ˜¯é™åˆ¶è¯·æ±‚çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°abæ¨¡å—æ¥æµ‹è¯•
```

**å®‰è£…**

```
yum -y install httpd-tools
```

**ä½¿ç”¨**

```
# -n æ€»å…±çš„è¯·æ±‚æ•°
# -c å¹¶å‘çš„è¯·æ±‚æ•°
ab -n 40 -c 20 http://127.0.0.1/
```

### 5.4.2.å…±äº«è¿æ¥å†…å­˜

**è¦æƒ³ä½¿ç”¨è¯·æ±‚é™åˆ¶ éœ€è¦å…ˆåˆ†é…ä¸€ä¸ªå…±äº«å†…å­˜**



nginxæœ‰ä¸€ä¸ªmasterè¿›ç¨‹å’Œn(ä¸€èˆ¬æ ¹æ®cpuæ ¸æ•°)ä¸ªworkerè¿›ç¨‹ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯(IP)ç»™æœåŠ¡å™¨å‘è¯·æ±‚ï¼Œä¼šéšæœºåˆ†é…ç»™ä¸€ä¸ªworker



æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåš ï¼Œåœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œè¿™ä¸ªç©ºé—´ä¼šå¯¹æ‰€æœ‰çš„workerè¿›è¡Œå†…å­˜å…±äº«ï¼Œè¿™é‡Œé¢å­˜æ”¾ç€æ‰€æœ‰çš„é™åˆ¶è¿æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬é™åˆ¶æ¯ç§’é’Ÿæ¯ä¸ªIPåªèƒ½è¿æ¥ä¸€æ¬¡ï¼Œç°åœ¨æœ‰ä¸€ä¸ªIPç»™æœåŠ¡å™¨å‘è¯·æ±‚ï¼Œè¿™æ—¶å€™ä¼šåˆ†é…åˆ°ä¸€ä¸ªworkerï¼Œè¿™ä¸ªworkerå°±ä¼šå¾€è¿™ä¸ªå…±äº«å†…å­˜ä¸­å†™å…¥ä¸€æ¡æ•°æ® æ¯”å¦‚ ipåœ°å€ä¸ºxxxçš„ åœ¨14:30:22çš„æ—¶å€™å‘èµ·äº†ä¸€ä¸ªè¯·æ±‚ï¼Œå»ºç«‹äº†ä¸€æ¬¡è¿æ¥ç­‰ä¿¡æ¯ï¼Œå¦‚æ­¤åŒæ—¶è¿™ä¸ªipåˆå‘é€äº†ä¸€ä¸ªè¯·æ±‚åˆ°è¿™ä¸ªæœåŠ¡å™¨ï¼Œè¢«åˆ«çš„workeræ¥å¤„ç†äº†ï¼Œè¿™æ—¶å€™è¿™ä¸ªworkerä¼šå…ˆå»å…±äº«ç©ºé—´æŸ¥è¯¢ä¸€ä¸‹æ˜¯å¦å­˜åœ¨é™åˆ¶ï¼Œè¿™æ—¶å€™æ­£å¥½æœ‰ä¸€æ¡è¿™ä¸ªipå‘çš„è¯·æ±‚æ—¶é—´æ˜¯åœ¨1ç§’å†…ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¸ç¬¦åˆæˆ‘ä»¬è®¾ç½®çš„1så†…1ä¸€ä¸ªIPåªèƒ½å‘é€1æ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥å°±ä¼šæ–­å¼€è¿™æ¬¡è¿æ¥



**è¯­æ³•**

```
# keyï¼šæˆ‘ä»¬å¯ä»¥ä»¥è¯·æ±‚çš„IPä¸ºkey  zoneï¼šç©ºé—´çš„åè¯ sizeï¼šä¸ºç©ºé—´ç”³è¯·çš„å¤§å°
# è¯´ç™½äº†keyå°±æ˜¯workerè¿‡æ¥æ‰¾çš„æ—¶å€™èƒ½å¤Ÿæ¯”å¯¹çš„æ ‡è¯†ç¬¦ ç”¨è¯·æ±‚çš„IPä¸ºkey

Syntax: limit_conn_zone key zone=name:size
Default: --
Context: http(å®šä¹‰åœ¨serverä»¥å¤–)
```

**ä¸¾ä¾‹**

```nginx
http {
  # $binary_remote_addr æ˜¯nginxçš„å˜é‡ è¡¨ç¤ºè¯·æ±‚çš„å®¢æˆ·ç«¯çš„IPåœ°å€
  # è¿™æ®µè¡¨ç¤º keyæ˜¯å®¢æˆ·ç«¯IP ç©ºé—´çš„åç§°æ˜¯conn_zone(è‡ªå®šä¹‰çš„)å¤§å°æ˜¯10m
  limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
  server: {
    xxx
  }
}
```

### 5.4.3 è¿æ¥é™åˆ¶

**è¯­æ³•**

```
# zoneè¡¨ç¤ºå…±äº«ç©ºé—´çš„åç§° numberï¼šé™åˆ¶æ•°é‡(æ¯ä¸ªå®¢æˆ·ç«¯æ¯ç§’åŒæ—¶è¿æ¥çš„æ•°é‡)

Syntax: limit_conn zone number
Default: --
Context: httpã€serverã€location
```

**é™„åŠ å±æ€§**

```nginx
 # æ–­å¼€è¿æ¥çš„è¿”å›çš„çŠ¶æ€ç  é»˜è®¤503
 limit_conn_status 500; 
 # æ–­å¼€è¿æ¥æ—¥å¿—çš„ç­‰çº§ info|notice|warn|error
 limit_conn_log_level warn;
 # æ¯ç§’æœåŠ¡å™¨åªèƒ½ç»™å®¢æˆ·ç«¯å‘é€50å­—èŠ‚
 limit_rate 50;
```



**ä¸¾ä¾‹**

```nginx
http {
  # åˆ›å»ºå…±äº«ç©ºé—´
  limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
  
  server {
    	
      location /zone {
        alias /opt/app;
        index blue.html;
      	# å…±äº«ç©ºé—´æ˜¯conn_zone æ¯ç§’é’ŸåŒä¸€ä¸ªIPåªèƒ½å‘èµ·ä¸€ä¸ªè¿æ¥
      	# è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ ä¸€ä¸ªè¿æ¥å¯ä»¥å‘æ— æ•°ä¸ªè¯·æ±‚
      	# è™½ç„¶æˆ‘ä»¬è¿™é‡Œé™åˆ¶äº†1ä¸ªè¿æ¥ã€‚æˆ‘ä»¬ç”¨abæµ‹è¯•çš„æ—¶å€™å‡å¦‚å¹¶å‘è®¾ç½®10 æ€»çš„è¯·æ±‚è®¾ç½®æˆ10ã€‚å¯èƒ½10ä¸ªè¯·æ±‚éƒ½æˆåŠŸäº† ä¹Ÿè‚¯åªæœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸ åŸå› å°±æ˜¯å¯èƒ½è¿™10ä¸ªè¯·æ±‚éƒ½èµ°çš„è¿™ä¸ªè¿æ¥
        limit_conn conn_zone 1;
        # æ–­å¼€è¿æ¥çš„è¿”å›çš„çŠ¶æ€ç  é»˜è®¤503
        limit_conn_status 500; 
        # æ–­å¼€è¿æ¥æ—¥å¿—çš„ç­‰çº§
        limit_conn_log_level warn;
        # æ¯ç§’æœåŠ¡å™¨åªèƒ½ç»™å®¢æˆ·ç«¯å‘é€50å­—èŠ‚
        limit_rate 50;
    }
  }
}
```

### 5.4.4 è¯·æ±‚é™åˆ¶

**æ³¨æ„:** limit_reqç”Ÿæ•ˆæ˜¯åœ¨limit_connä¹‹å‰



**å®šä¹‰å…±äº«å†…å­˜ è¯­æ³•**

```
# å› ä¸ºè¯·æ±‚é™åˆ¶çš„åŸç†æ˜¯ä¾é å…±äº«å†…å­˜çš„ è§£é‡Šå‚è€ƒä¸Šé¢çš„å…±äº«è¿æ¥å†…å­˜
# æ‰€ä»¥è¦é…ç½®ä¸€ä¸‹å…±äº«å†…å­˜
# key ä¸€èˆ¬ä½¿ç”¨å®¢æˆ·ç«¯ip  zone è‡ªå®šä¹‰åç§° size å¤§å° rate é€Ÿç‡
Syntax: limit_req_zone key zone=name:size rate=rate
Default:--
Context: http(å®šä¹‰åœ¨serverä»¥å¤–)
```



**è¯·æ±‚é™åˆ¶ è¯­æ³•**

```
# zone å…±äº«å†…å­˜åç§°
# burst ä¸‹é¢å…·ä½“è®²è§£  nodelay ä¸‹é¢å…·ä½“è®²è§£
Syntax: limit_req zone=name [burst=number] [nodelay]
Default: --
Context: http,server,location
```



**æ¡ˆä¾‹**

```nginx
# å®šä¹‰äº†å…±äº«ç©ºé—´ keyæ˜¯IPåœ°å€ã€‚åç§°æ˜¯req_zone å†…å­˜10mã€‚æ¯ç§’åªèƒ½å“åº”ä¸€æ¡æ•°æ®
limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;

# ä½¿ç”¨ ab -n 10 -c http://127.0.0.1/8888/req
# æ€»è¯·æ±‚æ•°æ˜¯10æ¡ å¹¶å‘æ˜¯1æ¡
# æˆ‘æµ‹è¯•çš„æ˜¯ä¸åˆ°1så°±å‘é€äº†è¿™ä¸ª10æ¡è¯·æ±‚ æ‰€ä»¥æˆåŠŸçš„è¯·æ±‚åªæœ‰1æ¡ å¤±è´¥äº†9æ¡
# å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†æ¯ç§’åªèƒ½å“åº”ä¸€æ¡æ•°æ®

server {    
    listen 8888;
    server_name localhost;

    location /req {
        alias /opt/app;
        index blue.html;
        limit_req zone=req_zone; 
    }
}
```

### 5.4.5 burstå‚æ•°

burst æ˜¯å¹²å˜›çš„å‘¢ çœ‹ä¸‹é¢è¯¦ç»†çš„è®²è§£

limit_req ä½¿ç”¨çš„æ˜¯æ¼æ–—ç®—æ³• ä»€ä¹ˆæ˜¯æ¼æ–—ç®—æ³•ç®—æ³•å‘¢ï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­

ç°åœ¨æœ‰ä¸€ä¸ªæ°´é¾™å¤´ ğŸš°ï¼Œæˆ‘ä»¬æ¥æ¥æ°´ï¼Œå‡è®¾æˆ‘ä»¬é™åˆ¶æ¯ç§’åªèƒ½æ¥ä¸€æ»´æ°´ï¼Œè¿™æ—¶å€™æ°´é¾™å¤´æ¯ç§’å°±æ»´ä¸€æ»´æ°´ï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬çš„é™åˆ¶ï¼Œä½†æ˜¯è¿™æ—¶å€™æ°´é¾™å¤´æ¯ç§’æ»´ 10 æ»´æ°´äº†ï¼Œé‚£ä¹ˆæ˜æ˜¾ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚äº†ï¼Œæ¯ç§’å¤šä½™çš„ 9 æ»´æ°´æˆ‘ä»¬åªèƒ½æŠ›å¼ƒäº†

ç°åœ¨æˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³• æˆ‘ä»¬åœ¨æ°´é¾™å¤´ä¸‹é¢æ”¾ä¸€ä¸ªæ¼æ–—(æ¡¶ã€ç›†éƒ½è¡Œ) è¿™ä¸ªæ¼æ–—æ¯ç§’å›ºå®šçš„åªèƒ½æµå‡ºä¸€æ»´æ°´ ä»–çš„å®¹é‡æ˜¯ 5 æ»´ ä¸‹é¢æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹ è¿™ 10 æ»´æ°´æ€ä¹ˆå¤„ç†çš„

**æ³¨æ„**

åœ¨æè¿°äº‹ä»¶æˆ–è€…è¿‡ç¨‹çš„æ—¶é—´çº¿æ—¶ï¼Œä»¥â€œç¬¬ 0 ç§’â€å¼€å§‹æ˜¯ä¸€ç§å¸¸è§çš„æ–¹å¼ï¼Œç”¨æ¥è¡¨ç¤ºä»æŸä¸ªç‰¹å®šåŠ¨ä½œå‘èµ·çš„åˆå§‹æ—¶åˆ»ã€‚è¿™å¹¶ä¸æ˜¯è¯´çœŸæ­£å­˜åœ¨ä¸€ä¸ªé›¶é•¿åº¦çš„ç¬¬ 0 ç§’ï¼Œè€Œæ˜¯ä¸ºäº†æ–¹ä¾¿è®¡ç®—å’Œè§£é‡Šï¼Œåœ¨æ—¶é—´åºåˆ—çš„èµ·ç‚¹æŒ‡å®šä¸ºç¬¬ 0 ç§’ã€‚

- ç¬¬ 0 ç§’çš„æ—¶å€™ æ¥äº† 10 æ»´ ç„¶åæ¯ç§’åªèƒ½å¤„ç† 1 æ»´ï¼Œå½“å‰æ²¡æœ‰æ­£åœ¨å¤„ç†çš„ï¼Œæ‰€ä»¥ä¼šå¤„ç† 1 æ»´, å‰©ä½™ 9 æ»´ å› ä¸ºæ¼æ–—çš„å®¹é‡æ˜¯ 5 æ‰€ä»¥è¿™ 9 æ»´åªæœ‰ 5 æ»´è¿›å…¥æ¼æ–—
- ç¬¬ 1 ç§’ æ¼æ–—æµå‡ºä¸€æ»´ è¿˜å‰© 4 æ»´
- ç¬¬ 2 ç§’ æ¼æ–—æµå‡ºä¸€æ»´ è¿˜å‰© 3 æ»´
- ç¬¬ 3 ç§’ æ¼æ–—æµå‡ºä¸€æ»´ è¿˜å‰© 2 æ»´
- ç¬¬ 4 ç§’ æ¼æ–—æµå‡ºä¸€æ»´ è¿˜å‰© 1 æ»´
- ç¬¬ 5 ç§’ æ¼æ–—æµå‡ºä¸€æ»´ è¿˜å‰© 0 æ»´
- æ‰€ä»¥ç”¨æ—¶ 5 ç§’ ä¸€å…±å¤„ç†äº† 6 æ»´

æ°´é¾™å¤´å…¶å®å°±ä»£è¡¨äº†å®¢æˆ·ç«¯(æµè§ˆå™¨)ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•æ§åˆ¶æµè§ˆå™¨æ¯ç§’çš„è¯·æ±‚æ•°é‡ï¼Œå¯èƒ½å½“å‰æµè§ˆå™¨å‘èµ·äº† 10 æ¡è¯·æ±‚ï¼Œæ¯ç§’è¯·æ±‚ä¸€æ¬¡ï¼Œä¹Ÿå¯èƒ½æ¯ç§’è¯·æ±‚ 5 æ¬¡é‚£ä¹ˆä¸¤ç§’å°±è¯·æ±‚å®Œæ¯•äº†ï¼Œæˆ–è€…è¯´ 1 ç§’å°±è¯·æ±‚ 10 æ¬¡

è™½ç„¶æˆ‘ä»¬æ— æ³•æ§åˆ¶å®¢æˆ·ç«¯ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ¼æ–—çš„æ’å®šæµé€Ÿ é‚£ä¹ˆ burst å…¶å®å°±æ˜¯å……å½“æ¼æ–— æˆ‘ä»¬å¯ä»¥è®¾å®šè¿™ä¸ªæ¼æ–—å¯ä»¥ç¼“å­˜å¤šå°‘æ•°æ®

**æ¡ˆä¾‹**

```nginx
# å®šä¹‰äº†å…±äº«ç©ºé—´ keyæ˜¯IPåœ°å€ã€‚åç§°æ˜¯req_zone å†…å­˜10mã€‚æ¯ç§’åªèƒ½å“åº”ä¸€æ¡æ•°æ®
limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;

server {
  location /req {
        alias /opt/app;
        index blue.html;
        limit_req zone=req_zone burst=5;
    }
}

```

### 5.4.6 nodelay å‚æ•°

ä¸Šé¢ burst æ¡ˆä¾‹æˆ‘ä»¬è¯´åˆ° æµè§ˆå™¨ä¸€æ¬¡å‘é€äº† 10 æ¡è¯·æ±‚ ï¼Œç„¶åæˆåŠŸå“åº”äº† 6 æ¡ è€—è´¹ 5s ä¸­ ä½†æ˜¯è®©ç”¨æˆ·ç­‰å¾… 5s æ˜¯ä¸å¥½çš„è¡Œä¸º

å¦‚æœè®¾ç½®äº† nodelayï¼Œåˆ™å³ä½¿è¯·æ±‚æš‚æ—¶è¶…å‡ºäº†æ¯ç§’å…è®¸çš„é¢‘ç‡ï¼Œåªè¦æ€»æ•°æ²¡æœ‰è¶…è¿‡ burst å¤§å°ï¼Œè¿™äº›è¯·æ±‚ä¹Ÿä¼šç«‹å³å¾—åˆ°å¤„ç†ï¼Œè€Œä¸ä¼šè¢«å»¶è¿Ÿã€‚å¼€å¯ nodelay åï¼ŒæœåŠ¡å™¨ä¼šç«‹åˆ»å¤„ç† burst å†…æ‰€æœ‰çš„è¯·æ±‚ï¼Œç„¶åæ¢å¤æ­£å¸¸çš„é€Ÿç‡æ§åˆ¶ã€‚

**æ¡ˆä¾‹**

```nginx
# å®šä¹‰äº†å…±äº«ç©ºé—´ keyæ˜¯IPåœ°å€ã€‚åç§°æ˜¯req_zone å†…å­˜10mã€‚æ¯ç§’åªèƒ½å“åº”ä¸€æ¡æ•°æ®
limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;

server {
  location /req {
        alias /opt/app;
        index blue.html;
        limit_req zone=req_zone burst=5 nodelay;
    }
}

```

ç»“åˆæ¡ˆä¾‹ æˆ‘ä»¬è®¾ç½®äº† nodelay ç„¶åæµè§ˆå™¨å¹¶å‘äº† 10 ä¸ªè¯·æ±‚

ç¬¬ä¸€ä¸ªè¯·æ±‚ç«‹å³è¢«å¤„ç†ï¼Œéšåçš„è¯·æ±‚ç›´åˆ°æ•°é‡è¾¾ åˆ° burst å€¼çš„é™åˆ¶éƒ½å°†ç«‹å³è·å¾—å¤„ç†ï¼Œè€Œä¸å¿…ç­‰å¾…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåŒæ—¶åˆ°è¾¾ 5 ä¸ªè¯·æ±‚ï¼Œåœ¨å¼€å¯äº† nodelay çš„æƒ…å†µä¸‹ï¼Œè¿™ 5 ä¸ªè¯·æ±‚å‡ ä¹ä¼šåŒæ—¶è¢«å¤„ç†ã€‚ä¹‹åæœåŠ¡å™¨å°†æ¢å¤åˆ°æ¯ç§’å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„é€Ÿç‡ã€‚

è¿™æ ·å®¢æˆ·ç«¯å°±ä¸ç”¨ç­‰å¾…äº† å¯ä»¥ç«‹é©¬è·å–ç»“æœ



##  5.5 è®¿é—®æ§åˆ¶

### 5.5.1 åŸºäºIpåœ°å€çš„è®¿é—®æ§åˆ¶

**æ¨¡å—å**

```
http_access_moudle
```

**ä½œç”¨**

```
å¯ä»¥è®¾ç½®å…è®¸è®¿é—®çš„ipã€‚ä¹Ÿå¯ä»¥è®¾ç½®ä¸å…è®¸è®¿é—®çš„ipã€‚æœ‰ä¸¤ç§å†™æ³•
```

**è¯­æ³•(allow)**

```
# å€¼å¯ä»¥æ˜¯ IPåœ°å€ æˆ–è€… all
# è¿™ä¸ªè¡¨ç¤ºå…è®¸å“ªäº›å¯ä»¥è®¿é—®
Syntax: allow address|all
Default: --
Context: http,server.location.limit_except
```

**è¯­æ³•(deny)**

```
# å€¼å¯ä»¥æ˜¯ IPåœ°å€ æˆ–è€… all æˆ–è€… CIDR
# è¿™ä¸ªè¡¨ç¤ºä¸å…è®¸å“ªä¸ªè®¿é—® ä¹Ÿå°±æ˜¯é™¤äº†è®¾ç½®çš„åœ°å€å…¶ä½™çš„éƒ½èƒ½è®¿é—®
Syntax: deny address|CIDR|all
Default: --
Context: http,server.location.limit_except
```

**æ¡ˆä¾‹**

```nginx
http {
  server {
    location /admin {
      alias /opt/app;
      # è¡¨ç¤ºåªè¦æ˜¯è¿™ä¸ªipè®¿é—®/admin éƒ½ä¸å…è®¸è®¿é—®
      deny 119.120.221.100;
      # å¯ä»¥è®¾ç½®å¤šä¸ªip
      deny 119.120.221.101;
      # å¯ä»¥å’ŒallowåŒæ—¶ä½¿ç”¨
      allow 119.120.221.101;
    }
    
    location /admin1 {
      alias /opt/app;
      # è¡¨ç¤ºåªå…è®¸è¿™ä¸ªipè®¿é—®/admin1 å…¶ä½™ipåœ°å€è®¿é—®/admin1éƒ½è¢«æ‹’ç»
      allow 119.120.221.100;
      # å¯ä»¥è®¾ç½®å¤šä¸ªip
      allow 119.120.221.101;
    }
  }
}
```

# 6 é™æ€èµ„æºwebæœåŠ¡å™¨

## 6.1 é™æ€èµ„æºå’ŒåŠ¨æ€èµ„æº

* **é™æ€èµ„æº**ï¼šä¸€èˆ¬å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°webæœåŠ¡å™¨ï¼ŒwebæœåŠ¡å™¨ä»å†…å­˜å†å–åˆ°ç›¸åº”çš„æ–‡ä»¶ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è§£æå¹¶æ¸²æŸ“å‡ºæ¥

```nginx
# æ¯”å¦‚æˆ‘æƒ³è®¿é—®æŸä¸ªå›¾ç‰‡ é‚£ä¹ˆç›´æ¥ä¼šä»æ–‡ä»¶å¤¹å»æ‹¿ï¼Œè¿™å°±æ˜¯é™æ€èµ„æº
http {
  server {
     location ~ .*\.(jpg|jpeg|png|gif) {
            root /usr/share/nginx/html;
        }
  }
}
```

* **åŠ¨æ€èµ„æº**ï¼šä¸€èˆ¬å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨æ€èµ„æºï¼Œç°å°†è¯·æ±‚å°†äºwebå®¹å™¨ï¼Œwebå®¹å™¨è¿æ¥æ•°æ®åº“ï¼Œæ•°æ®åº“å¤„ç†æ•°æ®ä¹‹åï¼Œå°†å†…å®¹äº¤ç»™webæœåŠ¡å™¨ï¼ŒwebæœåŠ¡å™¨è¿”å›ç»™å®¢æˆ·ç«¯è§£ææ¸²æŸ“å¤„ç†

```nginx
# ç°åœ¨æ‰€æœ‰çš„apiå¼€å¤´çš„è¯·æ±‚éƒ½ä¼šè¢«ä»£ç†åˆ°http://localhost:3000 è¿™å°±æ˜¯åŠ¨æ€èµ„æº
http {
  server {
    location ~ ^/api {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass  http://localhost:3000;
        }
  }
}
```

## 6.2 CDN

* CDNå…¨ç§°æ˜¯Content Delivery Networkï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œ
* CDNç³»ç»Ÿèƒ½å¤Ÿå®æ—¶çš„æ ¹æ®ç½‘ç»œæµé‡å’Œå„èŠ‚ç‚¹çš„è¿æ¥ã€è´Ÿè½½çŠ¶å†µä»¥åŠåˆ°ç”¨æˆ·çš„è·ç¦»å’Œå“åº”æ—¶é—´ç­‰ç»¼åˆä¿¡æ¯å°†ç”¨æˆ·çš„è¯·æ±‚é‡æ–°å¯¼å‘ç¦»ç”¨æˆ·æœ€è¿‘çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šã€‚å…¶ç›®çš„æ˜¯ä½¿ç”¨æˆ·å¯ä»¥å°±è¿‘å»çš„æ‰€éœ€å†…å®¹ï¼Œè§£å†³ç½‘ç»œæ‹¥æŒ¤çš„çŠ¶å†µï¼Œæé«˜ç”¨æˆ·è®¿é—®æˆ¿å±•çš„å“åº”é€Ÿåº¦ã€‚



* å¦‚æœæƒ³è¦æŠŠnginxä½œä¸ºCDNæœåŠ¡å™¨å¯ä»¥åšä»¥ä¸‹çš„ä¼˜åŒ–é…ç½®ï¼Œä¸åšä¹Ÿæ— æ‰€è°“



**è¯­æ³•**



```
# ä¸ç»è¿‡ç”¨æˆ·å†…æ ¸å‘é€æ–‡ä»¶ 
Syntax: sendfile on/off
Default: off
Context: httpã€serverã€locationã€if in location
```



**æ¡ˆä¾‹**

```nginx
```



## 6.3 tcp_nopushå’Œtcp_nodelay

**tcp_nopush**

* åœ¨å¼€å¯sendfileçš„æƒ…å†µä¸‹ï¼Œä¼šåˆå¹¶å¤šä¸ªæ•°æ®åŒ…ï¼Œæé«˜ç½‘ç»œåŒ…çš„ä¼ è¾“æ•ˆç‡
* å‡å¦‚æˆ‘ä»¬ç°åœ¨åœ¨ä¸‹è½½ç”µå½±ï¼Œæ¯ç§’éƒ½ä¼šå“åº”æ•°æ® è¿™æ—¶å€™å¼€å¯è¿™ä¸ªå°±ä¼šåˆå¹¶å¤šä¸ªå“åº” æ¯”å¦‚æ¯3ç§’å“åº”ä¸€æ¬¡ 

```
Syntax: tcp_nopush on/off
Default: off
Context: httpã€serverã€location
```



**tcp_nodelay**

* åœ¨keepaliveè¿æ¥ä¸‹ï¼Œæé«˜ç½‘ç»œåŒ…çš„å®æ—¶ä¼ è¾“æ€§
* å‡å¦‚ç°åœ¨æ¯ç§’å“åº”ä¸€ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆnginxä¼šç«‹åˆ»å“åº”ï¼Œä¸€èˆ¬ç”¨äºéœ€è¦å®æ—¶ä¼ è¾“æ•°æ®çš„æƒ…å†µï¼Œæ¯”å¦‚æ¸¸æˆæ•°æ® 

```
Syntax: tcp_nodelay on/off
Default: on
Context: httpã€serverã€location
```



## 6.4 gzip

**gzip**

* æ§åˆ¶gzipå‹ç¼©ç‡çš„
* å‹ç¼©æ¯”ç‡è¶Šé«˜ï¼Œæ–‡ä»¶è¢«å‹ç¼©çš„ä½“ç§¯è¶Šå°ï¼Œå¯¹åº”çš„åŠ è½½èµ„æºçš„é€Ÿåº¦å°±è¶Šæ…¢
* 1-9çº§åˆ«

```
Syntax: gzip on/off
Default: off
Context: httpã€serverã€location
```



**gzip_comp_level**

* æ§åˆ¶gzipå‹ç¼©ç‡çš„
* å‹ç¼©æ¯”ç‡è¶Šé«˜ï¼Œæ–‡ä»¶è¢«å‹ç¼©çš„ä½“ç§¯è¶Šå°ï¼Œå¯¹åº”çš„åŠ è½½èµ„æºçš„é€Ÿåº¦å°±è¶Šæ…¢
* 1-9çº§åˆ«

```
Syntax: gzip_comp_level level
Default: 1
Context: httpã€serverã€location
```



**gzip_http_version**

* ç”¨äºè¯†åˆ«httpåè®®çš„ç‰ˆæœ¬ï¼Œæ—©æœŸçš„æµè§ˆå™¨ä¸æ”¯æŒgzipå‹ç¼©ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ä¹±ç ï¼Œæ‰€ä»¥ä¸ºäº†æ”¯æŒå‰æœŸç‰ˆæœ¬åŠ äº†æ­¤é€‰é¡¹ã€‚é»˜è®¤åœ¨http/1.0çš„åè®®ä¸‹ä¸å¼€å¯gzipå‹ç¼©ã€‚

```
Syntax: gzip_http_version 1.0/1.1
Default: gzip_http_version 1.1
Context: httpã€serverã€location
```



**http_gzip-static_module**

* å¦‚æœæˆ‘ä»¬æ¯æ¬¡éƒ½åœ¨nginxä¸­è¿›è¡Œgzipå‹ç¼©ï¼Œé‚£ä¹ˆå‡å¦‚ç°åœ¨å¹¶å‘1000ä¸ªè¯·æ±‚é‚£ä¹ˆå°±è¦æ‰§è¡Œ1000æ¬¡gzipï¼Œæ€§èƒ½è‚¯å®šæ˜¯ä¸é«˜çš„
* å¦‚æœå¯ç”¨äº†è¿™ä¸ªæ¨¡å—ï¼Œå°±ä¼šå…ˆåœ¨æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°åŒåçš„`gz`æ–‡ä»¶æ˜¯å¦å­˜åœ¨
* æ¯”å¦‚ç°åœ¨æœ‰æ¥å£æ¥æ‰¾a.txt,é‚£ä¹ˆnginxä¼šå…ˆå°†a.txtå‹ç¼©(ä¸ä¼šåŠ¨åŸæ–‡ä»¶)ç„¶åæ‰è¿”å›ï¼Œç°åœ¨æˆ‘ä»¬ç›´æ¥å°†a.txtå‹ç¼©æˆ`a.txt.gz`ï¼Œå½“è¯·æ±‚è¿‡æ¥ ä¼šå…ˆæ‰¾`a.txt.gz`æ–‡ä»¶ï¼Œç„¶åç›´æ¥è¿”å›

```
Syntax: gzip_static on/off
Default: off
Context: httpã€serverã€location
```



**æ¡ˆä¾‹**

```nginx
http {
  server {
      # å›¾ç‰‡å°±ä¸å¼€å¯gzipå‹ç¼©äº† å› ä¸ºæœ¬èº«å›¾ç‰‡å°±æ˜¯è¢«å‹ç¼©è¿‡çš„
        location ~ .*\.(jpg|jpeg|png|gif) {
            gzip off;
            root /usr/share/nginx/html;
        }

        location ~ .*\.(html|js|css) {
            gzip on;
      			# å½“è¿”å›å†…å®¹å¤§äºæ­¤å€¼æ—¶æ‰ä¼šä½¿ç”¨gzipè¿›è¡Œå‹ç¼©,ä»¥Kä¸ºå•ä½,å½“å€¼ä¸º0æ—¶ï¼Œæ‰€æœ‰é¡µé¢éƒ½è¿›è¡Œå‹ç¼©ã€‚
            gzip_min_length 1k;
            gzip_http_version 1.1;
            gzip_comp_level   9;
            #è®¾ç½®éœ€è¦å‹ç¼©çš„MIMEç±»å‹,å¦‚æœä¸åœ¨è®¾ç½®ç±»å‹èŒƒå›´å†…çš„è¯·æ±‚ä¸è¿›è¡Œå‹ç¼©
            gzip_types text/css application/javascript;
            root /usr/share/nginx/html;
        }

        location ~ ^/download {
           gzip_static on;
           tcp_nopush on;
           root /usr/share/nginx/html;
        }
  }
}
```

# 7 æµè§ˆå™¨ç¼“å­˜

nginxå¤©ç”Ÿå°±æ”¯æŒæµè§ˆå™¨ç¼“å­˜ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å“åº”çš„æ—¶å€™ä¼šæºå¸¦etagå’Œlast-modifiedå­—æ®µï¼Œæ‰€ä»¥ä¸ç”¨åšä»»ä½•é…ç½®



[æµè§ˆå™¨ç¼“å­˜](https://excalidraw.com/#json=Pp460J3hFs7VN19GFMzqz,IB7-UgLaR8RzbbEsl0IfaA)



å”¯ä¸€éœ€è¦é…ç½®çš„å°±æ˜¯è¿‡æœŸæ—¶é—´



## 7.1 expires

æ³¨æ„å¦‚æœè®¾ç½®äº†expireså°±ç›¸å½“äºä½¿ç”¨å¼ºåˆ¶ç¼“å­˜äº†



**ä½œç”¨**

```
æ·»åŠ Cache-Controlã€Expireså¤´
```

**è¯­æ³•**

```
Syntax: expires time
Default: off
Context: httpã€serverã€location
```



**æ¡ˆä¾‹**

* ç†è®ºä¸Šè®¾ç½®äº†expiresï¼Œå½“æ—¶é—´æ²¡è¿‡æœŸï¼Œé‚£ä¹ˆå½“æˆ‘å†æ¬¡è¯·æ±‚è¿™ä¸ªå›¾ç‰‡çš„æ—¶å€™å°±ä¸ä¼šæƒ³æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜
* ä½†æ˜¯å› ä¸ºæµè§ˆå™¨çš„å·®å¼‚ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯chromeé‚£ä¹ˆå³ä½¿è®¾ç½®äº†expiresï¼Œæ²¡æœ‰è¿‡æœŸï¼Œè¿˜æ˜¯ä¼šå‘é€è¯·æ±‚ï¼ŒIEä¸ä¼šå‘é€å¯ä»¥è¯•ä¸€ä¸‹
* å¦‚æœä½¿ç”¨çš„æ˜¯imgæ ‡ç­¾srcç­‰äºè¿™ç§å›¾ç‰‡ï¼Œé‚£ä¹ˆchromeå°±ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œè¿™ä¸ªè¯·æ±‚çš„statusæ˜¯(200 OK (from memory cache))

```nginx
http {
  server {
      location ~ .*\.(jpg|jpeg|png|gif) {
      		# è¿‡æœŸæ—¶é—´24å°æ—¶
          expires 24h;
          root /usr/share/nginx/html;
      }
  }
}
```

# 8 è·¨åŸŸ

è§£å†³è·¨åŸŸå…¶å®åŸç†å°±æ˜¯æ·»åŠ ä¸€ä¸ªå“åº”å¤´



**è¯­æ³•**

```
Syntax: add_header name value
Default: --
Context: httpã€serverã€location
```

**æ¡ˆä¾‹**

```nginx
http {
  server {
     location ~ ^/api {
      			# æ·»åŠ ä¸€ä¸ªå“åº”å¤´ å…è®¸æ‰€æœ‰æº
            add_header Access-Control-Allow-Origin *;
            # æ·»åŠ ä¸€ä¸ªå“åº”å¤´ å…è®¸çš„æ–¹æ³•æ˜¯ä»€ä¹ˆ
            add_header Access-Control-Allow-Methods GET,POST;
            rewrite ^/api/(.*) /$1 break;
            proxy_pass  http://localhost:3000;
            
        }
  }
}
```

# 9 é˜²ç›—é“¾

* é˜²æ­¢ç½‘ç«™èµ„æºè¢«ç›—ç”¨
* ä¿è¯ä¿¡æ¯å®‰å…¨
* é˜²æ­¢æµé‡è¿‡é‡
* åŒºåˆ«å“ªäº›è¯·æ±‚æ˜¯éæ­£å¸¸çš„è¯·æ±‚

**ä»€ä¹ˆæ˜¯**

```
æ¯”å¦‚ç°åœ¨aç½‘ç«™æœ‰ä¸€ä¸ªå›¾ç‰‡ï¼Œåœ¨æ²¡æœ‰è®¾ç½®é˜²ç›—é“¾çš„æƒ…å†µä¸‹ ä»»ä½•ç½‘ç«™æ‹¿åˆ°è¿™ä¸ªå›¾ç‰‡çš„urléƒ½å¯ä»¥æ˜¾ç¤ºï¼Œä½†æ˜¯è¿™æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ç°åœ¨bç½‘ç«™æ˜¾ç¤ºçš„å…¨éƒ¨æ˜¯aç½‘ç«™çš„å›¾ç‰‡çš„ï¼Œé‚£ä¹ˆbç½‘ç«™å°±ä¸ç”¨åœ¨æœåŠ¡å™¨é‡Œå­˜å‚¨å›¾ç‰‡äº†ï¼Œç›´æ¥ä½¿ç”¨aç½‘ç«™çš„é“¾æ¥å³å¯ï¼Œè¿™è‚¯å®šæ˜¯ä¸å…è®¸çš„  æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®é˜²ç›—é“¾ è®¾ç½®å…è®¸å“ªäº›ç½‘ç«™å¯ä»¥è®¿é—®æˆ‘ä»¬æœåŠ¡å™¨çš„èµ„æºï¼Œé‚£äº›ä¸è¢«å…è®¸çš„ç½‘ç«™æƒ³è¦é“¾æ¥æˆ‘ä»¬ç½‘ç«™çš„èµ„æºå°±ä¼šæŠ¥é”™304(æ²¡æƒé™)

åŸç†
å½“æµè§ˆå™¨å‘èµ·è¯·æ±‚æ—¶ä¼šåœ¨requestHeaderä¸­æºå¸¦Refererå­—æ®µ  é‚£ä¹ˆnginxå°±æ˜¯é€šè¿‡è¿™ä¸ªå­—æ®µçš„å€¼å’Œæˆ‘ä»¬è®¾ç½®å…è®¸è®¿é—®çš„å€¼åšæ¯”å¯¹ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦æœ‰æƒé™

æ³¨æ„ å½“ç›´æ¥åœ¨æµè§ˆå™¨è¾“å…¥èµ„æºåœ°å€è¯·æ±‚å¤´ä¸­æ˜¯æ²¡æœ‰Refererçš„ æ‰€ä»¥é…ç½®çš„æ—¶å€™è¦æ˜¯ä¸å…è®¸æµè§ˆå™¨åœ°å€æ è®¿é—® å°±ä¸è¦åœ¨è§„åˆ™ä¸­è®¾ç½®none
```

**è¯­æ³•**

```
# server_namesã€IPæ˜¯å¿…å¡«çš„ noneã€blockå¯ä»¥ä¸å­˜åœ¨
Syntax: valid_referers noneã€blockã€server_namesã€IP
Default: --
Context: serverã€location
```

**æ¡ˆä¾‹**

```nginx
http {
  server {
     location ~ .*\.(jpg|jpeg|png|gif) {
      			# é…ç½®å…è®¸è®¿é—®çš„åœ°å€ã€‚å½“none(è¯·æ±‚å¤´æ²¡æœ‰refereræˆ–è€…å€¼æ˜¯ç©º) æˆ–è€… bolcked æˆ–è€…192.168.1.112åœ°å€
            valid_referers none blocked 192.168.1.112;
      			# å¦‚æœä¸æ˜¯å…è®¸çš„åœ°å€ è¿”å›403
            # $invalid_refererç³»ç»Ÿè‡ªå¸¦çš„å˜é‡ å¯ä»¥æ•è·åˆ°valid_referersä¹‹å¤–çš„å†…å®¹
            if ($invalid_referer) {
                return 403;
            }

            root /usr/share/nginx/html;
        }
  }
}
```

# 10 ä»£ç†æœåŠ¡

**ä»£ç†æœåŠ¡åˆ†æˆæ­£å‘ä»£ç†å’Œåå‘ä»£ç†**



**è¯­æ³•**

```
Syntax: proxy_pass URL
Default: --
Context: serverã€location
```



## 10.1 æ­£å‘ä»£ç†

* æ­£å‘ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯çœ‹ä¸åˆ°çœŸæ­£çš„å®¢æˆ·ç«¯

**æ¡ˆä¾‹**

```nginx
# å‡å¦‚www.jetli.com.cnæˆ‘ä»¬ç°åœ¨çš„ç½‘ç»œè®¿é—®ä¸äº†
# ç„¶åæˆ‘ä»¬å°±å¯ä»¥è®©nginxè¿›è¡Œä»£ç† è¿›è€Œè®¿é—®è¯¥ç½‘ç«™
# è¿™é‡Œè¦æ³¨æ„ è¦ä¿®æ”¹æœ¬åœ°çš„hostsæ–‡ä»¶è¦è®©www.jetli.com.cnåŸŸåæŒ‡å‘æˆ‘ä»¬çš„æœåŠ¡å™¨
# ä¸ç„¶æˆ‘ä»¬çš„æœåŠ¡å™¨æ‹¦æˆª ä¸äº†

http {
    server {
   # chromeçš„åŸŸåè§£æåœ°å€ ä¸€å®šè¦å†™ä¸ç„¶è¾“å…¥åŸŸåè§£æä¸äº†
   resolver 8.8.8.8;

    listen  7777;
    # è¿™é‡Œä¸€å®šè¦é…ç½®æƒ³è¦è®¿é—®çš„åŸŸå ä¸ç„¶è¿›ä¸æ¥nginx
    server_name localhost www.jetli.com.cn;

    location / {
      # $http_host è¯·æ±‚çš„ä¸»æœºå
      # $request_uri  è¯·æ±‚è·¯å¾„
      # å‡å¦‚æˆ‘ä»¬åœ¨åœ°å€æ è¯·æ±‚ www.jetli.com.cn/abc
      # é‚£ä¹ˆ$http_hostå°±æ˜¯ www.jetli.com.cn
      # $request_uriå°±æ˜¯/abc
       proxy_pass http://$http_host$request_uri;
    }
  }
  
  # æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æ­£å‘ä»£ç† ä»£ç†å¤–ç½‘
  # æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªé¦™æ¸¯çš„æœåŠ¡å™¨
  # ç„¶ååšå¦‚ä¸‹é…ç½®
  # ç„¶åå½“è®¿é—®7777ç«¯å£å°±ä¼šä»£ç†åˆ°yutubeäº†
  server {
    listen  7777;
    server_name localhost;

    location / {
       proxy_pass http://www.yutube.com;
    }
  }

}


```



## 10.2 åå‘ä»£ç†

* åçœä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯çœ‹ä¸åˆ°çœŸæ­£çš„æœåŠ¡ç«¯

**æ¡ˆä¾‹**

```nginx
http {
  server {
    location ~ ^/api {
            rewrite ^/api/(.*) /$1 break;
            # è®¾ç½®æ­£å‘ä»£ç† 
      			# å®¢æˆ·ç«¯æœ¬æ¥æƒ³è®¿é—®http://localhost:3000 
      			# ä½†æ˜¯å®é™…ä¸Šè®¿é—®çš„æ˜¯nginx ç„¶ånginxå»è®¿é—®3000ç«¯å£ ç„¶åç»“æœç»™åˆ°å®¢æˆ·ç«¯
            proxy_pass  http://localhost:3000;
            # å‘ä»£ç†çš„æœåŠ¡å™¨ä¼ é€’å¤´ä¿¡æ¯
      			proxy_set_header Host $http_host; 
            proxy_set_header X-Real-Ip $remote_addr;
      
            proxy_connect_timeout 30; # é»˜è®¤è¶…æ—¶æ—¶é—´ å•ä½s
            proxy_send_timeout 60; # è¯·æ±‚ä»£ç†æœåŠ¡å™¨ ä»£ç†æœåŠ¡å™¨å“åº”çš„è¶…æ—¶æ—¶é—´
            proxy_read_timeout 60; # è¯»å–ä»£ç†æœåŠ¡å™¨çš„å“åº” æ¯”å¦‚60sè¿˜æ²¡è¯»å–å®Œæ¯• ä¹Ÿç®—è¶…æ—¶
            
        }
  }
}
```

## 10.3 proxy_pass

* ä¸ºäº†æ–¹ä¾¿è®°å¿†å’Œè§„èŒƒé…ç½®ï¼Œå»ºè®®æ‰€æœ‰çš„`proxy_pass`åçš„urléƒ½ä»¥`/`ç»“å°¾



* `proxy_pass`åçš„urlæœ€ååŠ ä¸Š`/`å°±æ˜¯ç»å¯¹æ ¹è·¯å¾„ï¼Œ`location`ä¸­åŒ¹é…åˆ°çš„è·¯å¾„ä¼šè¢«æ›¿æ¢æ‰

```nginx
# è¯·æ±‚çš„åœ°å€æ˜¯ http://www.example.com/a/text.html
# ç„¶åå°±ä¼šä»£ç†åˆ° http://127.0.0.1/b/text.html

# /a/è¢«æ›¿æ¢æ‰äº†	ç›´æ¥èµ°ä»£ç†çš„è·¯å¾„äº†

# è¯·æ±‚çš„åœ°å€æ˜¯ http://www.example.com/a/
# ç„¶åå°±ä¼šä»£ç†åˆ° http://127.0.0.1/b/

http {
  server {
    location /a/ {
      proxy_pass http://127.0.0.1/b/;
    }
  }
}
```



* `proxy_pass`åçš„urlæœ€åä¸åŠ ä¸Š`/`å°±æ˜¯ç»å¯¹æ ¹è·¯å¾„ï¼Œ`location`ä¸­åŒ¹é…åˆ°çš„è·¯å¾„ä¼šä¿ç•™

```nginx
# è¯·æ±‚çš„åœ°å€æ˜¯ http://www.example.com/a/text.html
# ç„¶åå°±ä¼šä»£ç†åˆ° http://127.0.0.1/a/text.html

# /a/æ²¡æœ‰è¢«æ›¿æ¢æ‰

http {
  server {
    location /a/ {
      proxy_pass http://127.0.0.1;
    }
  }
}
```



* åœ¨`proxy_pass`å‰é¢ç”¨äº†`rewrite`ï¼Œè¿™ç§æƒ…å†µä¸‹ `proxy_pass`æ˜¯æ— æ•ˆçš„

```nginx
# è¿™ç§æƒ…å†µä¸‹proxy_passæ— æ•ˆ
http {
  server {
    location /a/ {
      rewrite /a/ break;
      proxy_pass http://127.0.0.1;
    }
  }
}
```



# 11 è´Ÿè½½å‡è¡¡

* ä½¿ç”¨é›†ç¾¤æ˜¯ç½‘ç«™è§£å†³é«˜å¹¶å‘ã€æµ·äº®æ•°æ®çš„å¸¸è§æ‰‹æ®µ
* å½“ä¸€å°æœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ã€å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶ï¼Œä¸è¦ä¼å›¾å»æ¢æ›´å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œå¯¹å¤§å‹ç½‘ç«™è€Œè¨€ï¼Œä¸ç®¡å¤šä¹ˆå¼ºå¤§çš„æœåŠ¡å™¨ï¼Œéƒ½æ»¡è¶³ä¸äº†ç½‘ç«™æŒç»­å¢é•¿çš„ä¸šåŠ¡éœ€æ±‚
* è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´æ°å½“çš„åšæ³•æ˜¯å¢åŠ ä¸€å°æœåŠ¡å™¨åˆ†æ‹…åŸæœ‰æœåŠ¡å™¨çš„è®¿é—®åŠå­˜å‚¨å‹åŠ›ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡è°ƒåº¦æœåŠ¡å™¨ï¼Œå°†æ¥è‡ªæµè§ˆå™¨çš„è®¿è¯·æ±‚åˆ†å‘åˆ°åº”ç”¨æœåŠ¡å™¨é›†ç¾¤ä¸­çš„ä»»ä½•ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå¦‚æœæœ‰æ›´å¤šçš„ç”¨æˆ·ï¼Œå°±åœ¨é›†ç¾¤ä¸­åŠ å…¥æ›´å¤šçš„åº”ç”¨æœåŠ¡å™¨ï¼Œä½¿åº”ç”¨æœåŠ¡å™¨çš„è´Ÿè½½å‹åŠ›ä¸å†æˆä¸ºæ•´ä¸ªç½‘ç«™çš„ç“¶é¢ˆ



**è´Ÿè½½å‡è¡¡æœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ä¸€ä¸ªèµ„æºæ± ï¼Œå½“è¯·æ±‚è¿›æ¥äº†ï¼Œnginxé»˜è®¤é€šè¿‡è½®è¯¢èµ„æºæ± åˆ†é…è¯·æ±‚**



**è¯­æ³•**

```
Syntax: upstream name {}
Default: --
Context: http
```



**æ¡ˆä¾‹**

```nginx
# æ³¨æ„èµ„æºæ± çš„ä½ç½®æ˜¯åœ¨httpä¸­ ä¸åœ¨serveræˆ–locationä¸­
# è¿™äº›æœåŠ¡æ¨¡æ‹Ÿæœ¬åœ°çš„ å¼€å‘ä¸­å¯ä»¥å¯¹åº”åˆ°ä¸åŒçš„æœåŠ¡å™¨åœ°å€
# cymæ˜¯è‡ªå®šä¹‰èµ„æºæ± åç§°
upstream cym {
  server 127.0.0.1:3000;
  server 127.0.0.1:4000;
  server 127.0.0.1:5000;
}

server {
  listen 7001;
  server_name localhost;

  location / {
    # å½“åŒ¹é…åˆ°è¯·æ±‚ å°±ä»£ç†åˆ°cymèµ„æºæ± ä¸­
    proxy_pass http://cym;
  }
}
```

## 11.1 åç«¯æœåŠ¡å™¨è°ƒè¯•çŠ¶æ€

| çŠ¶æ€         | æè¿°                                                         |
| ------------ | ------------------------------------------------------------ |
| down         | å½“å‰æœåŠ¡å™¨ä¸å‚ä¸è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¯·æ±‚ä¸ä¼šè¢«åˆ†é…ç»™è¿™ä¸ªæœåŠ¡å™¨ |
| backup       | å½“èµ„æºæ± å…¶ä»–çš„æœåŠ¡å™¨éƒ½æ— æ³•ä½¿ç”¨çš„æ—¶å€™ æ‰ä¼šä½¿ç”¨è¿™ä¸ªæœåŠ¡å™¨      |
| max_fails    | å…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œåˆ°è¾¾æœ€å¤§æ¬¡æ•°å°±ä¼šä¼‘çœ ã€‚egï¼šæ¯”å¦‚æœ‰ä¸€ä¸ªæœåŠ¡å™¨é…ç½®äº†è¿™ä¸ªå±æ€§ï¼Œæ¬¡æ•°2ï¼Œé‚£ä¹ˆå‡å¦‚è¿™ä¸ªæœåŠ¡å™¨æŒ‚äº†ä¹Ÿä¼šè¯·æ±‚ è¯·æ±‚2æ¬¡ä¹‹åä¾ç„¶æ²¡å“åº” å°±ä¼šä¼‘çœ ï¼Œä¼‘çœ æ—¶é—´çœ‹fail_timeout |
| fail_timeout | ç»è¿‡max_failså¤±è´¥åï¼ŒæœåŠ¡å™¨æš‚åœçš„æ—¶é—´ï¼Œé»˜è®¤10s               |
| max_conns    | é™åˆ¶æ¯ä¸ªserveræœ€å¤§çš„æ¥æ”¶çš„è¿æ¥æ•°ï¼Œæ€§èƒ½é«˜çš„æœåŠ¡å™¨å¯ä»¥è¿æ¥å¤šä¸€äº› |

**ä¸¾ä¾‹**

```nginx
# è¿™äº›å€¼ æ¯ä¸ªæœåŠ¡å™¨å¯ä»¥è®¾ç½®ä¹Ÿå¯ä»¥ä¸è®¾ç½®
upstream cym {
  server 127.0.0.1:3000 down;
  server 127.0.0.1:4000 backup;
  server 127.0.0.1:5000;
}

server {
  listen 7001;
  server_name localhost;

  location / {
    proxy_pass http://cym;
  }
}
```

## 11.2 åˆ†é…æ–¹å¼

* ä¸Šé¢è¯´åˆ° åˆ†é…æœåŠ¡å™¨çš„æ–¹å¼é»˜è®¤æ˜¯è½®è¯¢ï¼Œä¸‹é¢æ˜¯ä¸åŒçš„åˆ†é…æ–¹å¼

| ç±»å‹                             | å«ä¹‰                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| è½®è¯¢(é»˜è®¤)                       | æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨downæ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ |
| weight(åŠ æƒè½®è¯¢)                 | æŒ‡å®šæƒé‡ï¼Œæƒé‡è¶Šé«˜åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§                           |
| ip_hash                          | æ¯ä¸ªè¯·æ±‚æŒ‰ç…§ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·å¦‚æœæ˜¯åŒä¸€ä¸ªipçš„è¯·æ±‚å°±åˆ†é…ç»™ä¹‹å‰åˆ†é…åˆ°çš„æœåŠ¡å™¨ï¼Œä¸ç”¨åˆ†é…æ–°çš„æœåŠ¡å™¨ |
| least_conn                       | å“ªä¸ªæœºå™¨ä¸Šçš„è¿æ¥æ•°å°‘å°±åˆ†é…ç»™è°                               |
| url_hash(ä¸‰æ–¹ï¼Œéœ€è¦å®‰è£…å¯¹åº”æ¨¡å—) | æŒ‰è®¿é—®çš„urlåœ°å€hashæ¥åˆ†é…ï¼Œå°±æ˜¯è¯´å¦‚æœè®¿é—®çš„urlåœ°å€ç›¸åŒçš„è¯å°±ä¼šåˆ†é…åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Š |
| fair(ä¸‰æ–¹çš„ï¼Œéœ€è¦å®‰è£…å¯¹åº”æ¨¡å—)   | æŒ‰ç…§åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…     |
| è‡ªå®šä¹‰hash                       | hashè‡ªå®šä¹‰key                                                |

**ä¸¾ä¾‹**

```nginx
# è¿™äº›å€¼ æ¯ä¸ªæœåŠ¡å™¨å¯ä»¥è®¾ç½®ä¹Ÿå¯ä»¥ä¸è®¾ç½®
upstream cym {
  ip_hash;
  server 127.0.0.1:3000;
}

upstream cym1 {
  least_conn;
  server 127.0.0.1:3000;
}

upstream cym2 {
  server 127.0.0.1:3000 weight=2;
  server 127.0.0.1:4000 weight=3;
  server 127.0.0.1:5000;
}

server {
  listen 7001;
  server_name localhost;

  location / {
    proxy_pass http://cym;
  }
}
```



# 12 æ—¥å¿—

## 12.1 æ—¥å¿—ç±»å‹

* è®¿é—®æ—¥å¿— /var/log/nginx/accsess.log
* é”™è¯¯æ—¥å¿— /var/log/nginx/error.log



**è¯­æ³•**

```
Synatx: log_format name [escape=default[json] string]
Default: log_format combined ''
Context: http
```



## 12.2 å†…ç½®å˜é‡

* ä¸‹é¢æ˜¯éƒ¨åˆ†å¸¸ç”¨çš„ï¼Œå…·ä½“çš„çœ‹å®˜ç½‘

| åç§°             | å«ä¹‰                       |
| ---------------- | -------------------------- |
| $remote_addr     | å®¢æˆ·ç«¯åœ°å€                 |
| $remote_user     | å®¢æˆ·ç«¯ç”¨æˆ·åç§°             |
| $time_local      | è®¿é—®æ—¶é—´å’Œæ—¶åŒº             |
| $request         | è¯·æ±‚è¡Œ                     |
| $status          | HTTPè¯·æ±‚çŠ¶æ€               |
| $body_bytes_sent | å‘é€ç»™å®¢æˆ·ç«¯æ–‡ä»¶çš„å†…å®¹å¤§å° |

## 12.3 httpè¯·æ±‚å˜é‡

* æ³¨æ„è¦æŠŠè¯·æ±‚å¤´ä¸­çš„`-`è½¬ä¸º`_`ï¼Œæ¯”å¦‚User-Angetå¯¹åº”`$http_user_agent`
* æ¯”å¦‚æƒ³è¦æŸ¥çœ‹è¯·æ±‚å¤´çš„`Accept-Language` åªè¦è¿™æ ·å³å¯ `$http_Accept_Language`

| åç§°             | å«ä¹‰       | ä¸¾ä¾‹                          |
| ---------------- | ---------- | ----------------------------- |
| arg_PARAMETER    | è¯·æ±‚çš„å‚æ•° | $arg_name æŸ¥çœ‹keyæ˜¯nameçš„å‚æ•° |
| http_HEADER      | è¯·æ±‚å¤´     | $http_referer                 |
| sent_http_HEADER | å“åº”å¤´     | sent_http_cookie              |

**FAQ**  æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªipæ˜¯é€šè¿‡ä»£ç†æ¥è®¿é—®çš„ï¼Œæ€ä¹ˆå¯ä»¥è·å–æºå¤´çš„IPå‘¢



å¯ä»¥é€šè¿‡`$http_x_forwarded_for`, ä»–ä¼šè·å–åˆ°ä»£ç†è¿‡ç¨‹

æ¯”å¦‚ï¼š IP1>IP2(ä»£ç†)->IP3   IP1é€šè¿‡IP2ä»£ç†åˆ°IP3   è¿™ä¸ªæ—¶å€™$http_x_forwarded_for=IPï¼Œproxy(1),Proxy(2) IP



# 13 location

## 13.1 è¯­æ³•è§„åˆ™

* locationä»…åŒ¹é…URLï¼Œå¿½ç•¥å‚æ•°
  * è®¿é—®/a?name=zs åªä¼šåŒ¹é…/a ä¸ä¼šåŒ¹é…/a?name=zs
* **å‰ç¼€å­—ç¬¦ä¸²åŒ¹é…æœ‰ä»¥ä¸‹3ç§**
  * å¸¸è§„åŒ¹é…
  * =ç²¾ç¡®åŒ¹é…
  * ^~åŒ¹é…ä¸Šååˆ™ä¸ä¼šè¿›è¡Œæ­£åˆ™åŒ¹é… `è¿™é‡Œçš„^è¡¨ç¤ºå–åçš„æ„æ€`
* **æ­£åˆ™åŒ¹é…**
  * ~å¤§å°å†™æ•æ„Ÿçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
  * ~*å¿½ç•¥å¤§å°å†™çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
* **å†…éƒ¨è·³è½¬**
  * ç”¨äºå†…éƒ¨è·³è½¬çš„å‘½ålocation @

**è¯­æ³•**

```
Synatx: location [=|~|~*|^~] uri {...}
Default: -
Context: server,location
```



**æ¡ˆä¾‹**

```nginx
http {
  server {
     # ç²¾ç¡®åŒ¹é… è·¯å¾„å¿…é¡»æ˜¯/cym  
        location = /cym {
            return 200 "ç²¾ç¡®åŒ¹é…cym";
        }

        # å¸¸è§„åŒ¹é… åŒ¹é…çš„æ˜¯/apiå‰ç¼€
        location /api {
            return 200 "å¸¸è§„åŒ¹é… åŒ¹é…/apiå¼€å¤´çš„";
        }

        # å¿½ç•¥æ­£åˆ™çš„åŒ¹é…
        # å¦‚æœåŒ¹é…åˆ°è¿™ä¸ª åé¢æœ‰ä¸ªlocationæ˜¯ ~ /user
        # é‚£ä¹ˆä¼šä½¿ç”¨è¿™ä¸ª è€Œä¸ä½¿ç”¨æ­£åˆ™çš„åŒ¹é…
        location ^~ /user {
            return 200 "å¿½ç•¥æ­£åˆ™åŒ¹é…";
        }

        # æ­£åˆ™åŒ¹é… åŒºåˆ†å¤§å°å†™ åŒ¹é… /post/æ•°å­—
        # ä½¿ç”¨ ï½ å¼€å¤´
        location ~ /post/(\d+) {
            return 200 "æ­£åˆ™åŒ¹é… åŒºåˆ†å¤§å°å†™  $1";
        }

        # æ­£åˆ™åŒ¹é… ä¸åŒºåˆ†å¤§å°å†™ 
        # /Link/1  /LiNk/1 è¿™æ ·éƒ½èƒ½åŒ¹é…åˆ°
        # ä½¿ç”¨ ï½* å¼€å¤´
        location ~* /LINK/(\d+) {
            return 200 "æ­£åˆ™åŒ¹é… ä¸åŒºåˆ†å¤§å°å†™  $1";
        }
  }
}
```

## 13.2 åŒ¹é…è§„åˆ™

**ä¼˜å…ˆçº§æŒ‰ç…§é¡ºåº**

1. ç­‰å·ç±»å‹(=)çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œåˆ™ä¸åœ¨æŸ¥æ‰¾å…¶ä»–åŒ¹é…é¡¹
2. ^~ç±»å‹è¡¨è¾¾å¼ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œåˆ™ä¸åœ¨æŸ¥æ‰¾å…¶ä»–åŒ¹é…é¡¹
3. æ­£åˆ™è¡¨è¾¾å¼ç±»å‹(~,~*)çš„ä¼˜å…ˆçº§æ¬¡ä¹‹ï¼Œå¦‚æœå¤šä¸ªlocationçš„æ­£åˆ™åŒ¹é…çš„è¯ï¼Œåˆ™ä½¿ç”¨è¡¨è¾¾å¼æœ€é•¿çš„é‚£ä¸ª
4. å¸¸è§„å­—ç¬¦ä¸²ç±»å‹æŒ‰å‰ç¼€åŒ¹é…



**æ¡ˆä¾‹**

```nginx
http {
  server {
       location ~ /T1/\d+ { # ç¼–å·1
            return 200 "cym";
        }

        location ~ /T1/\d+/a { # ç¼–å·2
            return 200 "kkkk";
        }

        location /a { # ç¼–å·3
            return 200 "å­—ç¬¦ä¸²åŒ¹é…";
        }

        location /a/b/c { # ç¼–å·4
            return 200 "æœ€é•¿å­—ç¬¦ä¸²";
        }
  }
}

# FQA

# Qï¼šè¾“å…¥http://localhost/T1/2/a ä¼šèµ°å“ªä¸ªlocation
# Aï¼šç¼–å·1ã€‚ æƒ³æ³•ä¸Šä¼šæ˜¯ç¼–å·2,å› ä¸ºè·¯å¾„å®Œå…¨ç¬¦åˆç¼–å·2 å› ä¸ºé¡ºåºä¸åŒï¼Œæ­£åˆ™åŒ¹é…ä¼šæŒ‰ç…§é¡ºåºä¼˜å…ˆåŒ¹é…

# Qï¼šè¾“å…¥http://localhost/a/b/c/d ä¼šèµ°å“ªä¸ªlocation
# Aï¼šç¼–å·4ã€‚ æƒ³æ³•ä¸Šä¼šæ˜¯ç¼–å·3, å› ä¸ºè·¯å¾„åŒ¹é…/aå‰ç¼€äº†ï¼Œä½†æ˜¯åŒ¹é…å‰ç¼€è§„åˆ™æ˜¯æŒ‰ç…§æœ€é•¿è¡¨è¾¾å¼æ¥åŒ¹é…çš„ å› ä¸º/a/b/c/d ç¬¦åˆ location /a/b/c 
```



# 14 rewrite

**è¯­æ³•**

```
# flag:ç”¨æ¥è®¾ç½®rewriteå¯¹URIçš„å¤„ç†è¡Œä¸º
Synatx: rewrite regex replacement [flag]
Default: -
Context: server,location,if
```

* å¦‚æœæ­£åˆ™è¡¨è¾¾å¼(regex)åŒ¹é…åˆ°äº†è¯·æ±‚å¾—åˆ°URIï¼Œè¿™ä¸ªURIä¼šè¢«åé¢çš„replacementæ›¿æ¢
* rewriteçš„å®šå‘ä¼šæ ¹æ®ä»–ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ
* é€šè¿‡flagå¯ä»¥ç»ˆæ­¢å®šå‘åè¿›ä¸€æ­¥çš„å¤„ç†



**ç”¨é€”**

* URLé¡µé¢è·³è½¬
* å…¼å®¹æ—§ç‰ˆæœ¬
* SEOä¼˜åŒ–(ä¼ªé™æ€)
* ç»´æŠ¤(åå°ç»´æŠ¤ã€æµé‡è½¬å‘)
* ç­‰



**æ¡ˆä¾‹**

```nginx
http {
  server {
    location / {
      # å¦‚æœurlç¬¦åˆ^(.*)$æ­£åˆ™ åˆ™ä¼šæ‰“å¼€rootè·¯å¾„ä¸‹çš„back.html
            rewrite ^(.*)$ /back.html break;
        }
    
    location /bd {
      # å¦‚æœurlç¬¦åˆ^(.*)$æ­£åˆ™ åˆ™ä¼šè·³è½¬baiduå®˜ç½‘
            rewrite ^(.*)$ http://www.baidu.com break;
        }
  }
}
```

## 14.1 flagå‚æ•°

**flag:ç”¨æ¥è®¾ç½®rewriteå¯¹URIçš„å¤„ç†è¡Œä¸º**

| flag      | å«ä¹‰                                                         |
| --------- | ------------------------------------------------------------ |
| last      | å…ˆåŒ¹é…è‡ªå·±çš„locationï¼Œç„¶åé€šè¿‡rewriteè§„åˆ™æ–°å»ºä¸€ä¸ªè¯·æ±‚å†æ¬¡è¯·æ±‚æœåŠ¡ç«¯ |
| break     | å…ˆåŒ¹é…è‡ªå·±çš„locationï¼Œç„¶åç”Ÿå‘½å‘¨æœŸä¼šåœ¨å½“å‰çš„locationç»“æŸï¼Œä¸å†è¿›è¡Œåç»­çš„åŒ¹é… |
| redirect  | è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œä»¥åè¿˜ä¼šè¯·æ±‚è¿™ä¸ªæœåŠ¡å™¨                    |
| premanent | è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œä»¥åä¼šç›´æ¥è¯·æ±‚æ°¸ä¹…é‡å®šå‘åçš„åŸŸå          |

**last**

* ç»“æŸå½“å‰çš„è¯·æ±‚å¤„ç†ï¼Œç”¨æ›¿æ¢åçš„URIé‡æ–°åŒ¹é…location
* å¯ä»¥ç†è§£ä¸ºé‡å†™(rewrite)åï¼Œå‘èµ·äº†ä¸€ä¸ªæ–°çš„è¯·æ±‚ï¼Œè¿›å…¥serveræ¨¡å—ï¼ŒåŒ¹é…location
* å¦‚æœé‡æ–°åŒ¹é…å¾ªç¯çš„æ¬¡æ•°è¶…è¿‡äº†10æ¬¡ï¼Œnginxä¼šè¿”å›500çš„é”™è¯¯
* è¿”å›çš„200çš„çŠ¶æ€ç ã€‚

```nginx
# å¦‚æœç¬¦åˆlocation é‚£ä¹ˆåˆ™ä¼šä½¿ç”¨/teståœ¨serveræ¨¡å—ä¸­é‡æ–°è¿›è¡ŒåŒ¹é…
# æ‰€ä»¥ä¼šè¿”å›200çš„çŠ¶æ€ç 

http {
  server {
    location ~  ^/last {
            rewrite ^/last /test last;
        }
        location /test {
            return 200 "hhä½ å¥½";
        }
  }
}
```

**break**

* ç»“æŸå½“å‰çš„è¯·æ±‚å¤„ç†ï¼Œä½¿ç”¨å½“å‰èµ„æºï¼Œä¸åœ¨æ‰§è¡Œå½“å‰locationçš„ä½™ä¸‹è¯­å¥
* è¿”å›301 çŠ¶æ€ç 
* æµè§ˆå™¨åœ°å€æ˜¾ç¤ºä»å®šå‘åçš„url

```nginx

http {
  server {
       location ~  ^/break1 {
            # ä¼šæŠŠ^/break1æ›¿æ¢æˆ/test
            # ç›¸å½“äºä½¿ç”¨è¿™ä¸ªè·¯å¾„ http://location/test
            # é‚£ä¹ˆå…¶å®å°±æ˜¯å»æ‰¾ã€‚ /test/index.html
            rewrite ^/break1 /test break;
            index index.html;
            # ä¸åœ¨æ‰§è¡Œè¿™ä¸ªè¯­å¥
            rewrite ^/break /test break;
        }
  }
}
```

**redirect**

* ä¸´æ—¶è·³è½¬ï¼Œè¿”å›302 httpçŠ¶æ€ç 
* æµè§ˆå™¨åœ°å€æ˜¾ç¤ºé‡å®šå‘åçš„url
* ä¸´æ—¶é‡å®šå‘ï¼Œä¸‹æ¬¡è¯·æ±‚è¿˜èµ°nginx

```nginx
http {
  server {
    location ~ ^/redirect {
            rewrite ^/redirect http://www.baidu.com redirect;
        }
  }
}
```





**permanent**

* æ°¸ä¹…è·³è½¬ï¼Œè¿”å›301 httpçŠ¶æ€ç 
* æµè§ˆå™¨åœ°å€æ˜¾ç¤ºé‡å®šå‘åçš„url
* æ°¸ä¹…é‡å®šå‘ï¼Œä¸‹æ¬¡è¯·æ±‚ä¸èµ°nginxï¼Œç›´æ¥è®¿é—®é‡å®šå‘çš„åœ°å€

```nginx
http {
  server {
    location ~ ^/permanent {
            rewrite ^/permanent http://www.qq.com permanent; 
        }
  }
}
```

